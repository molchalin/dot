#!/usr/bin/env bash

set -o errexit
set -o pipefail


LOG_FILE="$HOME/.local/state/pomodoro/log.jsonl"
mkdir -p $(dirname $LOG_FILE)
touch $LOG_FILE

function start-pomodoro() {
    NOW=$(date "+%s")
    MINUTES="${1:-25}"
    INFO="${2:-DEFAULT}"
    END=$(($NOW + $MINUTES * 60))
    DAY=$(date "+%F")
    jq -cn '$ARGS.named' --arg end "$END" --arg meta.day "$DAY" --arg meta.text "$INFO" --arg dur "${MINUTES}m" >> $LOG_FILE
}

function status-pomodoro() {
    END=$(tail -n 1 $LOG_FILE | jq -r '.end')
    NOW=$(date "+%s")
    RES=$(( $END - $NOW ))
    if [[ $RES -lt 0 ]]; then
        printf "\\ue001"
        exit 0;
    fi
    printf "\\ue003 "
    date --date "@${RES}" '+%M:%S'
}


case $1 in
    start)
        start-pomodoro "$2" "$3"
        ;;
    status)
        status-pomodoro
        ;;
    *)
        printf "unknown command %q" $1
        exit 1;
        ;;
esac
