#!/bin/bash

set -o errexit
set -o pipefail

URL=$1
echo "Downloading $URL";

if [[ -d "/Volumes/WALKMAN/" ]]; then
  DST_DIR="/Volumes/WALKMAN/"
fi

if [[ -d "/run/media/$USER/WALKMAN/" ]]; then
  DST_DIR="/run/media/$USER/WALKMAN/"
fi

if [[ -z "$DST_DIR" ]]; then
  DST_DIR="$HOME/Downloads"
fi

if [[ -d "$DST_DIR/MUSIC" ]]; then
  DST_DIR="$DST_DIR/MUSIC"
fi

if [[ $URL =~ "youtube" ]]; then
  echo "youtube"
  if [[ -d "$DST_DIR/0PODCAST" ]]; then
    DST_DIR="$DST_DIR/0PODCAST"
  fi
  yt-dlp -x -P "$DST_DIR" --audio-format mp3 $URL
else

  TMPDIR=$(mktemp -d)
  pushd "$TMPDIR"

  docker run --rm -v $(pwd):/music spotdl/spotify-downloader download "$URL" | tee output
  popd

  ALBUM_NAME=$(cat "$TMPDIR/output" | fgrep 'Found' | perl -anE '/Found .* in (.*) \(Album\)/; say $1')
  echo "album: $ALBUM_NAME"
  if [[ -z "$ALBUM_NAME" ]]; then
    exit 1
  fi
  rm "$TMPDIR/output"

  ARTIST_NAME=$(ls "$TMPDIR" | head -n 1 | cut -d '-' -f 1)
  echo "artist: $ARTIST_NAME"
  if [[ -z "$ARTIST_NAME" ]]; then
    exit 1
  fi

  SRC="${ARTIST_NAME}- $ALBUM_NAME"
  echo "$SRC"
  mv "$TMPDIR" "$SRC"
  mv "$SRC" "$DST_DIR"
fi

if [[ -d "/Volumes/WALKMAN/" ]]; then
  fd -H "^\._" /Volumes/WALKMAN --exec rm "{}" \;
fi
